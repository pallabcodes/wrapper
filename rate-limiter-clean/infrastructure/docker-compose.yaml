version: "3.8"

services:
  # --- Rate Limiter Storage ---
  redis:
    image: redis:alpine
    container_name: rate-limiter-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: rate-limiter-gui
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis

  # ============================================================================
  # Kong API Gateway - CONFIGURED BUT NOT ACTIVELY USED
  # ============================================================================
  # Kong is included to demonstrate production-ready infrastructure awareness
  # but is NOT currently integrated with the rate limiter service.
  #
  # Current Flow:  Client → Rate Limiter (Port 3001) → Redis/Kafka
  # With Kong:     Client → Kong (Port 8000) → Rate Limiter → Redis/Kafka
  #
  # To integrate Kong:
  #   1. Configure services via Admin API (localhost:8001)
  #   2. Route traffic through Kong proxy (localhost:8000)
  #   3. Optional: Use Kong's rate limiting plugins (competes with custom logic)
  #
  # Kept for future extensibility: Auth, CORS, SSL termination, API orchestration
  # ============================================================================

  # --- Kong API Gateway DB ---
  kong-db:
    image: postgres:13
    container_name: kong-db
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "kong"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Kong API Gateway ---
  kong:
    image: kong:3.4
    container_name: rate-limiter-kong
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444 ssl
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8001:8001"
      - "8444:8444"
    depends_on:
      kong-db:
        condition: service_healthy
    restart: on-failure

  # --- Kong Migrations (Bootstrap) ---
  kong-migrations:
    image: kong:3.4
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
    command: kong migrations bootstrap
    depends_on:
      kong-db:
        condition: service_healthy

  # --- Redpanda (Kafka) ---
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.2.14
    container_name: rate-limiter-redpanda
    command:
      - redpanda start
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --node-id 0
      - --check=false
      - --kafka-addr PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
      - --pandaproxy-addr 0.0.0.0:8082
      - --advertise-pandaproxy-addr localhost:8082
    ports:
      - "9092:9092"
      - "8082:8082"
    volumes:
      - redpanda_data:/var/lib/redpanda/data

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v2.3.1
    container_name: rate-limiter-redpanda-ui
    environment:
      KAFKA_BROKERS: redpanda:29092
    ports:
      - "8083:8080"
    depends_on:
      - redpanda

  # --- Observability ---
  prometheus:
    image: prom/prometheus:v2.49.1
    container_name: rate-limiter-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  grafana:
    image: grafana/grafana:10.2.3
    container_name: rate-limiter-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3002:3000" # Mapped to 3002 to avoid conflict if user has other stuff
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  redis_data:
  kong_data:
  redpanda_data:
  grafana_data:
