<nav class="fixed-top w-100 border-bottom" style="background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-color: var(--border-light) !important; z-index: 1050; transition: box-shadow 0.3s ease;" id="mainNavbar">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between" style="height: 4rem;">
      <!-- Logo -->
      <a href="/" class="d-flex align-items-center text-decoration-none gap-3">
        <div class="d-flex align-items-center justify-content-center rounded-3" style="width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%); box-shadow: var(--shadow-sm);">
          <span class="text-white fw-bold fs-6">&lt;/&gt;</span>
        </div>
        <div class="d-none d-sm-block">
          <span class="fs-5 fw-semibold" style="color: var(--text-primary); letter-spacing: -0.01em;">Platform</span>
        </div>
      </a>
      
      <!-- Right Side Actions -->
      <div class="d-flex align-items-center gap-3">
        <!-- User Menu (shown when authenticated) -->
        <div id="authenticatedMenu" class="d-none d-sm-flex align-items-center gap-3" style="display: none !important; visibility: hidden; position: absolute; opacity: 0; pointer-events: none;">
          <a href="/auth/profile" class="px-3 py-2 small fw-medium text-decoration-none rounded-3" style="color: var(--text-secondary);" 
             onmouseover="this.style.color='var(--text-primary)'; this.style.backgroundColor='var(--bg-secondary)';" 
             onmouseout="this.style.color='var(--text-secondary)'; this.style.backgroundColor='transparent';">
            Profile
          </a>
          <a href="/auth/logout" onclick="handleLogout(event)" class="px-4 py-2 small fw-semibold text-decoration-none rounded-3 border-0" 
             style="background-color: var(--color-primary-600); color: var(--text-inverse); box-shadow: var(--shadow-sm);" 
             onmouseover="this.style.backgroundColor='var(--color-primary-700)'; this.style.boxShadow='var(--shadow-md)';" 
             onmouseout="this.style.backgroundColor='var(--color-primary-600)'; this.style.boxShadow='var(--shadow-sm)';">
            Sign Out
          </a>
        </div>
        <!-- Auth Links (shown when not authenticated) -->
        <div id="unauthenticatedMenu" class="d-none d-sm-flex align-items-center gap-3" style="position: relative;">
          <a href="/auth/login" class="px-3 py-2 small fw-medium text-decoration-none rounded-3" style="color: var(--text-secondary);" 
             onmouseover="this.style.color='var(--text-primary)'; this.style.backgroundColor='var(--bg-secondary)';" 
             onmouseout="this.style.color='var(--text-secondary)'; this.style.backgroundColor='transparent';">
            Sign In
          </a>
          <a href="/auth/register" class="px-4 py-2 small fw-semibold text-decoration-none rounded-3 border-0" 
             style="background-color: var(--color-primary-600); color: var(--text-inverse); box-shadow: var(--shadow-sm);" 
             onmouseover="this.style.backgroundColor='var(--color-primary-700)'; this.style.boxShadow='var(--shadow-md)';" 
             onmouseout="this.style.backgroundColor='var(--color-primary-600)'; this.style.boxShadow='var(--shadow-sm)';">
            Register
          </a>
        </div>
        
        <!-- Mobile Menu Button -->
        <button 
          id="mobileMenuBtn" 
          class="d-sm-none btn p-2 rounded-3 border-0"
          style="background-color: var(--bg-secondary); color: var(--text-primary);"
          onmouseover="this.style.backgroundColor='var(--bg-tertiary)';"
          onmouseout="this.style.backgroundColor='var(--bg-secondary)';"
          aria-label="Toggle menu"
          type="button"
        >
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Mobile Menu -->
  <div id="mobileMenu" class="d-sm-none border-top" style="border-color: var(--border-light) !important; background-color: var(--bg-primary); display: none;">
    <div class="container px-4 py-3 d-flex flex-column gap-2">
      <!-- Authenticated Mobile Menu -->
      <div id="authenticatedMobileMenu" style="display: none;">
        <a href="/auth/profile" class="px-4 py-2.5 small fw-medium text-decoration-none rounded-3" style="color: var(--text-secondary);" 
           onmouseover="this.style.color='var(--text-primary)'; this.style.backgroundColor='var(--bg-secondary)';" 
           onmouseout="this.style.color='var(--text-secondary)'; this.style.backgroundColor='transparent';">
          Profile
        </a>
        <a href="/auth/logout" onclick="handleLogout(event)" class="px-4 py-2.5 small fw-semibold text-decoration-none rounded-3 text-center border-0" 
           style="background-color: var(--color-primary-600); color: var(--text-inverse);" 
           onmouseover="this.style.backgroundColor='var(--color-primary-700)';" 
           onmouseout="this.style.backgroundColor='var(--color-primary-600)';">
          Sign Out
        </a>
      </div>
      <!-- Unauthenticated Mobile Menu -->
      <div id="unauthenticatedMobileMenu">
        <a href="/auth/login" class="px-4 py-2.5 small fw-medium text-decoration-none rounded-3" style="color: var(--text-secondary);" 
           onmouseover="this.style.color='var(--text-primary)'; this.style.backgroundColor='var(--bg-secondary)';" 
           onmouseout="this.style.color='var(--text-secondary)'; this.style.backgroundColor='transparent';">
          Sign In
        </a>
        <a href="/auth/register" class="px-4 py-2.5 small fw-semibold text-decoration-none rounded-3 text-center border-0" 
           style="background-color: var(--color-primary-600); color: var(--text-inverse);" 
           onmouseover="this.style.backgroundColor='var(--color-primary-700)';" 
           onmouseout="this.style.backgroundColor='var(--color-primary-600)';">
          Register
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- Spacer for fixed navbar -->
<div style="height: 4rem;"></div>

<script>
  // Logout handler - clears localStorage before navigating
  window.handleLogout = function(event) {
    event.preventDefault();
    // Clear localStorage tokens
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    // Navigate to logout route (which clears cookies and redirects)
    window.location.href = '/auth/logout';
  };

  // Check authentication status and update header
  function updateHeaderAuthStatus() {
    const token = localStorage.getItem('accessToken');
    const authenticatedMenu = document.getElementById('authenticatedMenu');
    const unauthenticatedMenu = document.getElementById('unauthenticatedMenu');
    const authenticatedMobileMenu = document.getElementById('authenticatedMobileMenu');
    const unauthenticatedMobileMenu = document.getElementById('unauthenticatedMobileMenu');

    // Immediately hide both menus to prevent flicker
    if (authenticatedMenu) {
      authenticatedMenu.style.display = 'none';
      authenticatedMenu.style.visibility = 'hidden';
      authenticatedMenu.style.position = 'absolute';
      authenticatedMenu.style.opacity = '0';
      authenticatedMenu.style.pointerEvents = 'none';
    }
    if (unauthenticatedMenu) {
      unauthenticatedMenu.style.display = 'none';
      unauthenticatedMenu.style.visibility = 'hidden';
      unauthenticatedMenu.style.position = 'absolute';
      unauthenticatedMenu.style.opacity = '0';
      unauthenticatedMenu.style.pointerEvents = 'none';
    }

    if (token) {
      // Verify token is still valid
      fetch('/api/users/me', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
        .then(r => r.json())
        .then(data => {
          if (data.data) {
            // Token is valid - show authenticated menu
            if (authenticatedMenu) {
              authenticatedMenu.style.display = 'flex';
              authenticatedMenu.style.visibility = 'visible';
              authenticatedMenu.style.position = 'relative';
              authenticatedMenu.style.opacity = '1';
              authenticatedMenu.style.pointerEvents = 'auto';
            }
            if (unauthenticatedMenu) {
              unauthenticatedMenu.style.display = 'none';
              unauthenticatedMenu.style.visibility = 'hidden';
              unauthenticatedMenu.style.position = 'absolute';
              unauthenticatedMenu.style.opacity = '0';
              unauthenticatedMenu.style.pointerEvents = 'none';
            }
            if (authenticatedMobileMenu) {
              authenticatedMobileMenu.style.display = 'block';
            }
            if (unauthenticatedMobileMenu) {
              unauthenticatedMobileMenu.style.display = 'none';
            }
          } else {
            // Token is invalid - show unauthenticated menu
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            if (authenticatedMenu) {
              authenticatedMenu.style.display = 'none';
              authenticatedMenu.style.visibility = 'hidden';
              authenticatedMenu.style.position = 'absolute';
              authenticatedMenu.style.opacity = '0';
              authenticatedMenu.style.pointerEvents = 'none';
            }
            if (unauthenticatedMenu) {
              unauthenticatedMenu.style.display = 'flex';
              unauthenticatedMenu.style.visibility = 'visible';
              unauthenticatedMenu.style.position = 'relative';
              unauthenticatedMenu.style.opacity = '1';
              unauthenticatedMenu.style.pointerEvents = 'auto';
            }
            if (authenticatedMobileMenu) {
              authenticatedMobileMenu.style.display = 'none';
            }
            if (unauthenticatedMobileMenu) {
              unauthenticatedMobileMenu.style.display = 'block';
            }
          }
        })
        .catch(() => {
          // Error verifying token - show unauthenticated menu
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          if (authenticatedMenu) {
            authenticatedMenu.style.display = 'none';
            authenticatedMenu.style.visibility = 'hidden';
            authenticatedMenu.style.position = 'absolute';
            authenticatedMenu.style.opacity = '0';
            authenticatedMenu.style.pointerEvents = 'none';
          }
          if (unauthenticatedMenu) {
            unauthenticatedMenu.style.display = 'flex';
            unauthenticatedMenu.style.visibility = 'visible';
            unauthenticatedMenu.style.position = 'relative';
            unauthenticatedMenu.style.opacity = '1';
            unauthenticatedMenu.style.pointerEvents = 'auto';
          }
          if (authenticatedMobileMenu) {
            authenticatedMobileMenu.style.display = 'none';
          }
          if (unauthenticatedMobileMenu) {
            unauthenticatedMobileMenu.style.display = 'block';
          }
        });
    } else {
      // No token - show unauthenticated menu
      if (authenticatedMenu) {
        authenticatedMenu.style.display = 'none';
        authenticatedMenu.style.visibility = 'hidden';
        authenticatedMenu.style.position = 'absolute';
        authenticatedMenu.style.opacity = '0';
        authenticatedMenu.style.pointerEvents = 'none';
      }
      if (unauthenticatedMenu) {
        unauthenticatedMenu.style.display = 'flex';
        unauthenticatedMenu.style.visibility = 'visible';
        unauthenticatedMenu.style.position = 'relative';
        unauthenticatedMenu.style.opacity = '1';
        unauthenticatedMenu.style.pointerEvents = 'auto';
      }
      if (authenticatedMobileMenu) {
        authenticatedMobileMenu.style.display = 'none';
      }
      if (unauthenticatedMobileMenu) {
        unauthenticatedMobileMenu.style.display = 'block';
      }
    }
  }
  
  // Run immediate check (synchronous) before DOMContentLoaded
  (function() {
    const token = localStorage.getItem('accessToken');
    const authenticatedMenu = document.getElementById('authenticatedMenu');
    const unauthenticatedMenu = document.getElementById('unauthenticatedMenu');
    
    // Hide both menus immediately
    if (authenticatedMenu) {
      authenticatedMenu.style.display = 'none';
      authenticatedMenu.style.visibility = 'hidden';
      authenticatedMenu.style.position = 'absolute';
      authenticatedMenu.style.opacity = '0';
      authenticatedMenu.style.pointerEvents = 'none';
    }
    if (unauthenticatedMenu) {
      unauthenticatedMenu.style.display = 'none';
      unauthenticatedMenu.style.visibility = 'hidden';
      unauthenticatedMenu.style.position = 'absolute';
      unauthenticatedMenu.style.opacity = '0';
      unauthenticatedMenu.style.pointerEvents = 'none';
    }
    
    // If no token, show unauthenticated menu immediately
    if (!token && unauthenticatedMenu) {
      unauthenticatedMenu.style.display = 'flex';
      unauthenticatedMenu.style.visibility = 'visible';
      unauthenticatedMenu.style.position = 'relative';
      unauthenticatedMenu.style.opacity = '1';
      unauthenticatedMenu.style.pointerEvents = 'auto';
    }
  })();

  // Mobile menu toggle
  document.addEventListener('DOMContentLoaded', function() {
    // Update header auth status on page load (with async token verification)
    updateHeaderAuthStatus();

    const menuBtn = document.getElementById('mobileMenuBtn');
    const menu = document.getElementById('mobileMenu');
    
    if (menuBtn && menu) {
      menuBtn.addEventListener('click', function() {
        const isHidden = menu.style.display === 'none' || !menu.style.display;
        menu.style.display = isHidden ? 'block' : 'none';
        const icon = this.querySelector('i');
        if (icon) {
          icon.classList.toggle('fa-bars');
          icon.classList.toggle('fa-times');
        }
      });
    }
    
    // Navbar scroll effect - premium shadow
    const nav = document.getElementById('mainNavbar');
    if (nav) {
      let lastScroll = 0;
      window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        if (currentScroll <= 0) {
          nav.style.boxShadow = 'none';
        } else {
          nav.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
        }
        lastScroll = currentScroll;
      });
    }

    // Listen for storage changes (when user logs in/out in another tab)
    window.addEventListener('storage', function(e) {
      if (e.key === 'accessToken') {
        updateHeaderAuthStatus();
      }
    });
  });

  // Make function globally accessible for manual updates
  window.updateHeaderAuthStatus = updateHeaderAuthStatus;
</script>
