<% const emailValue = typeof query !== 'undefined' && query.email ? query.email : ''; %>

<div class="min-vh-100 d-flex align-items-center justify-content-center p-4" style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); padding-top: 5rem !important;">
  <div class="w-100" style="max-width: 24rem;">
    <div class="text-center mb-4">
      <h1 class="fs-3 fw-bold mb-2" style="color: var(--text-primary);">Reset Password</h1>
      <p class="small mb-0" style="color: var(--text-secondary);">Enter the code and your new password</p>
    </div>

    <div class="rounded-3 border p-4" style="background-color: var(--bg-primary); border-color: var(--border-light) !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
      <form action="/api/auth/reset-password" method="POST" id="resetPasswordForm">
        <%- include('../partials/form-input', {
          id: 'email',
          name: 'email',
          type: 'email',
          label: 'Email',
          placeholder: 'you@example.com',
          value: emailValue,
          required: true,
          autocomplete: 'email',
          icon: 'fas fa-envelope'
        }) %>

        <div class="mb-3">
          <label for="code" class="form-label fw-semibold small mb-2" style="color: var(--text-primary);">Reset Code</label>
          <div class="position-relative">
            <input type="text" id="code" name="code" placeholder="000000" required maxlength="6" pattern="[0-9]{6}" class="form-control pe-5 ps-3 py-2" style="border-color: var(--border-medium); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem; letter-spacing: 0.25em; font-family: monospace; font-weight: 600; text-align: left; transition: all 0.2s ease; padding-right: 4rem !important;" onfocus="this.style.borderColor='var(--color-primary-600)'; this.setSelectionRange(0, 0);" onblur="this.style.borderColor='var(--border-medium)';" onclick="this.setSelectionRange(0, 0);">
            <div class="position-absolute top-50 end-0 translate-middle-y d-flex align-items-center px-2" style="right: 1.75rem; color: var(--text-tertiary); pointer-events: none;">
              <i class="fas fa-key" style="font-size: 1.125rem;"></i>
            </div>
          </div>
          <p class="mt-1 small mb-0" style="color: var(--text-tertiary);">Enter the 6-digit code</p>
        </div>

        <%- include('../partials/form-input', {
          id: 'password',
          name: 'password',
          type: 'password',
          label: 'New Password',
          placeholder: 'Create password',
          required: true,
          autocomplete: 'new-password',
          icon: 'fas fa-lock'
        }) %>

        <%- include('../partials/form-input', {
          id: 'confirmPassword',
          name: 'confirmPassword',
          type: 'password',
          label: 'Confirm Password',
          placeholder: 'Confirm password',
          required: true,
          autocomplete: 'new-password',
          icon: 'fas fa-lock'
        }) %>

        <button type="submit" class="btn w-100 py-2 fw-semibold rounded-2 border-0 mb-3" style="background-color: var(--color-primary-600); color: var(--text-inverse); transition: all 0.2s ease;" onmouseover="if (!this.disabled) { this.style.backgroundColor='var(--color-primary-700)'; }" onmouseout="if (!this.disabled) { this.style.backgroundColor='var(--color-primary-600)'; }">
          Reset Password
        </button>
      </form>

      <div class="text-center">
        <a href="/auth/login" class="small fw-medium text-decoration-none d-inline-flex align-items-center gap-2" style="color: var(--color-primary-600);">
          <i class="fas fa-arrow-left"></i>
          <span>Back to sign in</span>
        </a>
      </div>
    </div>
  </div>
</div>

<% const scriptsContent = `<script src="/assets/form-validation.js"></script><script>document.addEventListener('DOMContentLoaded',function(){const emailInput=document.getElementById('email');if(emailInput&&emailInput.value){emailInput.readOnly=true;emailInput.style.backgroundColor='var(--bg-tertiary)';}FormValidation.setupEmailValidation('email');FormValidation.setupPasswordValidation('password',8);FormValidation.setupPasswordValidation('confirmPassword',8);});document.getElementById('resetPasswordForm').addEventListener('submit',async function(e){e.preventDefault();const password=document.getElementById('password').value;const confirmPassword=document.getElementById('confirmPassword').value;if(password!==confirmPassword){alert('Passwords do not match!');return;}const submitBtn=this.querySelector('button[type="submit"]');const originalContent=submitBtn.innerHTML;submitBtn.disabled=true;submitBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Resetting...';const formData=new FormData(this);const data=Object.fromEntries(formData);delete data.confirmPassword;try{const response=await fetch('/api/auth/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await response.json();if(response.ok){alert('Password reset successful!');setTimeout(()=>{window.location.href='/auth/login?success=Password reset successful!';},2000);}else{alert(result.message||'Password reset failed');submitBtn.disabled=false;submitBtn.innerHTML=originalContent;}}catch(error){alert('An error occurred. Please try again.');submitBtn.disabled=false;submitBtn.innerHTML=originalContent;}});</script>`; %>
<%- include('../layouts/base', { title: 'Reset Password - Platform', body: '', scripts: scriptsContent }) %>
