<% 
  // Prefill with demo credentials for easy testing
  const emailValue = typeof formData !== 'undefined' && formData.email ? formData.email : 'demo@example.com';
  const passwordValue = typeof formData !== 'undefined' && formData.password ? formData.password : 'demo123456';
  const successMessage = typeof success !== 'undefined' && success ? success : null;
  const errorMessage = typeof query !== 'undefined' && query.error ? query.error : null;
%>

<div class="min-vh-100 d-flex align-items-center justify-content-center p-4" style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); padding-top: 5rem !important;">
  <div class="w-100" style="max-width: 24rem;">
    <div class="text-center mb-4">
      <h1 class="fs-3 fw-bold mb-2" style="color: var(--text-primary);">Sign in</h1>
      <p class="small mb-0" style="color: var(--text-secondary);">Enter your credentials to continue</p>
    </div>

    <% if (successMessage) { %>
      <div class="alert alert-success alert-dismissible fade show mb-3 rounded-3" role="alert" style="background-color: #d1e7dd; border-color: #badbcc; color: #0f5132;">
        <i class="fas fa-check-circle me-2"></i><%= successMessage %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <% if (errorMessage) { %>
      <div class="alert alert-danger alert-dismissible fade show mb-3 rounded-3" role="alert" style="background-color: #f8d7da; border-color: #f5c2c7; color: #842029;">
        <i class="fas fa-exclamation-circle me-2"></i><%= errorMessage === 'session_expired' ? 'Your session has expired. Please sign in again.' : errorMessage %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <div class="rounded-3 border p-4" style="background-color: var(--bg-primary); border-color: var(--border-light) !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
      <form action="/api/auth/login" method="POST" id="loginForm">
        <%- include('../partials/form-input', {
          id: 'email',
          name: 'email',
          type: 'email',
          label: 'Email',
          placeholder: 'you@example.com',
          value: emailValue,
          required: true,
          autocomplete: 'email',
          icon: 'fas fa-envelope'
        }) %>

        <div class="mb-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <label for="password" class="form-label fw-semibold small mb-0" style="color: var(--text-primary);">Password</label>
            <a href="/auth/forgot-password" class="text-decoration-none small" style="color: var(--color-primary-600);">Forgot?</a>
          </div>
          <div class="position-relative">
            <input type="password" id="password" name="password" value="<%= passwordValue %>" placeholder="Enter password" required autocomplete="current-password" class="form-control pe-5 ps-3 py-2" style="border-color: var(--border-medium); background-color: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s ease; padding-right: 4rem !important;" onfocus="this.style.borderColor='var(--color-primary-600)';" onblur="this.style.borderColor='var(--border-medium)';">
            <button type="button" id="togglePassword" class="position-absolute top-50 end-0 translate-middle-y border-0 bg-transparent d-flex align-items-center px-2" style="right: 1.75rem; color: var(--text-tertiary); cursor: pointer; outline: none; transition: color 0.2s ease;" onmouseover="this.style.color='var(--color-primary-600)'" onmouseout="this.style.color='var(--text-tertiary)'" onclick="togglePasswordVisibility()">
              <i class="fas fa-eye" id="passwordToggleIcon" style="font-size: 1.125rem;"></i>
            </button>
            <div id="passwordIcon" class="position-absolute top-50 end-0 translate-middle-y d-flex align-items-center opacity-0" style="right: 1rem; pointer-events: none; transition: opacity 0.3s ease;">
              <i class="fas fa-check-circle small" style="color: var(--color-success);"></i>
            </div>
          </div>
          <div id="passwordError" class="mt-1 small opacity-0" style="color: var(--color-error); transition: all 0.3s ease;"></div>
        </div>

        <div class="mb-3 d-flex align-items-center">
          <input type="checkbox" id="rememberMe" name="rememberMe" class="form-check-input me-2" style="accent-color: var(--color-primary-600); cursor: pointer;">
          <label for="rememberMe" class="form-check-label small mb-0" style="color: var(--text-secondary); cursor: pointer;">Remember me</label>
        </div>

        <button type="submit" class="btn w-100 py-2 fw-semibold rounded-2 border-0 mb-3" style="background-color: var(--color-primary-600); color: var(--text-inverse); transition: all 0.2s ease;" onmouseover="if (!this.disabled) { this.style.backgroundColor='var(--color-primary-700)'; }" onmouseout="if (!this.disabled) { this.style.backgroundColor='var(--color-primary-600)'; }">
          Sign In
        </button>
      </form>

      <div class="position-relative my-3">
        <div class="position-absolute top-50 start-0 w-100"><hr class="my-0" style="border-color: var(--border-light);"></div>
        <div class="position-relative text-center"><span class="px-2 small" style="background-color: var(--bg-primary); color: var(--text-tertiary);">Or</span></div>
      </div>

      <%- include('../partials/oauth-buttons') %>

      <div class="mt-3 text-center">
        <p class="small mb-0" style="color: var(--text-secondary);">Don't have an account? <a href="/auth/register" class="fw-semibold text-decoration-none" style="color: var(--color-primary-600);">Sign up</a></p>
      </div>
    </div>
  </div>
</div>

<% const scriptsContent = `
<script src="/assets/form-validation.js"></script>
<script>
  // Toggle password visibility function
  window.togglePasswordVisibility = function() {
    const passwordInput = document.getElementById('password');
    const toggleIcon = document.getElementById('passwordToggleIcon');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleIcon.classList.remove('fa-eye');
      toggleIcon.classList.add('fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      toggleIcon.classList.remove('fa-eye-slash');
      toggleIcon.classList.add('fa-eye');
    }
  };
  
  console.log('[LOGIN] Script loaded - DOMContentLoaded handler registered');
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[LOGIN] DOMContentLoaded fired - initializing form validation');
    FormValidation.setupEmailValidation('email');
    FormValidation.setupPasswordValidation('password', 6);
    
    // Test redirect function
    window.testRedirect = function() {
      console.log('[LOGIN] TEST: Testing redirect function...');
      window.location.href = '/dashboard';
    };
    console.log('[LOGIN] Test redirect function available: window.testRedirect()');
  });

  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !FormValidation.validateEmail(email)) {
      FormValidation.showError(document.getElementById('email'), document.getElementById('emailError'), 'Please enter a valid email');
      document.getElementById('email').focus();
      return;
    }
    
    if (!password || password.length < 6) {
      FormValidation.showError(document.getElementById('password'), document.getElementById('passwordError'), 'Password must be at least 6 characters');
      document.getElementById('password').focus();
      return;
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalContent = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    try {
      console.log('[LOGIN] ========================================');
      console.log('[LOGIN] Starting login request...');
      console.log('[LOGIN] Email:', email);
      console.log('[LOGIN] Password length:', password.length);
      
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      console.log('[LOGIN] ========================================');
      console.log('[LOGIN] Fetch completed');
      console.log('[LOGIN] Response status:', response.status);
      console.log('[LOGIN] Response ok:', response.ok);
      console.log('[LOGIN] Response statusText:', response.statusText);
      console.log('[LOGIN] Response Content-Type:', response.headers.get('content-type'));
      console.log('[LOGIN] Response headers:', Object.fromEntries(response.headers.entries()));
      
      // Get response as text first to check content type, then parse as JSON
      const responseText = await response.text();
      console.log('[LOGIN] ========================================');
      console.log('[LOGIN] Raw response text length:', responseText.length);
      console.log('[LOGIN] Raw response text (first 500 chars):', responseText.substring(0, 500));
      
      let result;
      try {
        result = JSON.parse(responseText);
        console.log('[LOGIN] ✅ JSON parsed successfully');
      } catch (e) {
        console.error('[LOGIN] ❌ ERROR: Failed to parse JSON:', e);
        console.error('[LOGIN] Full response text:', responseText);
        alert('Invalid response from server. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
        return;
      }
      
      console.log('[LOGIN] ========================================');
      console.log('[LOGIN] Parsed result:', result);
      console.log('[LOGIN] result type:', typeof result);
      console.log('[LOGIN] result.success:', result.success, '(type:', typeof result.success, ')');
      console.log('[LOGIN] result.data:', result.data);
      console.log('[LOGIN] result.data exists?', !!result.data);
      console.log('[LOGIN] result.data.tokens:', result.data?.tokens);
      console.log('[LOGIN] result.data.tokens exists?', !!result.data?.tokens);
      
      // Check if login was successful
      const isSuccess = response.ok && response.status === 200 && result && result.success === true;
      
      console.log('[LOGIN] ========================================');
      console.log('[LOGIN] Login result check:');
      console.log('[LOGIN] - response.ok:', response.ok);
      console.log('[LOGIN] - response.status:', response.status);
      console.log('[LOGIN] - result exists:', !!result);
      console.log('[LOGIN] - result.success:', result?.success);
      console.log('[LOGIN] - isSuccess:', isSuccess);
      
      if (isSuccess) {
        console.log('[LOGIN] ✅ Login successful!');
        
        // Store tokens in localStorage AND cookie for server-side auth
        if (result.data && result.data.tokens) {
          const accessToken = result.data.tokens.accessToken;
          const refreshToken = result.data.tokens.refreshToken;
          
          // Store in localStorage for client-side API calls
          if (accessToken) {
            localStorage.setItem('accessToken', accessToken);
          }
          if (refreshToken) {
            localStorage.setItem('refreshToken', refreshToken);
          }
          
          // Set cookie for server-side authentication (required for protected routes)
          // Cookie expires in 15 days (matches refresh token expiration)
          const expires = new Date();
          expires.setTime(expires.getTime() + (15 * 24 * 60 * 60 * 1000));
          document.cookie = 'accessToken=' + accessToken + ';expires=' + expires.toUTCString() + ';path=/;SameSite=Lax';
          
          console.log('[LOGIN] ✅ Tokens stored (localStorage + cookie)');
        }
        
        // Get redirect URL - simple and direct
        const urlParams = new URLSearchParams(window.location.search);
        const redirectUrl = urlParams.get('redirect') || '/dashboard';
        
        // Production-ready redirect: Immediate, clean navigation
        window.location.replace(redirectUrl);
        
        // Return immediately - no further code execution
        return;
      } else {
        // Login failed
        console.error('[LOGIN] ❌ Login failed');
        console.error('[LOGIN] Response:', {
          ok: response.ok,
          status: response.status,
          result: result
        });
        alert(result?.message || 'Login failed. Please check your credentials.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
      }
    } catch (error) {
      console.error('[LOGIN] Exception occurred:', error);
      alert('An error occurred. Please try again.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalContent;
    }
  });
</script>
`; %>
<%- include('../layouts/base', { title: 'Sign In - Platform', body: '', scripts: scriptsContent }) %>
