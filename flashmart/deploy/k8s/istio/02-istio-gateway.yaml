---
# Istio Gateway - External traffic entry point
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: flashmart-gateway
  namespace: flashmart
spec:
  selector:
    istio: ingressgateway  # Use Istio's default ingress gateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "*"  # Allow all hosts for development
    - port:
        number: 443
        name: https
        protocol: HTTPS
      tls:
        mode: SIMPLE  # Enable TLS termination
        credentialName: flashmart-tls  # Kubernetes secret name for certificates
      hosts:
        - api.flashmart.com  # Production domain

---
# Virtual Service - Route external traffic to services
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: flashmart-routing
  namespace: flashmart
spec:
  hosts:
    - "*"  # Match all hosts
  gateways:
    - flashmart-gateway
  http:
    # API Gateway routes
    - match:
        - uri:
            prefix: "/graphql"
        - uri:
            prefix: "/api-docs"
        - uri:
            prefix: "/health"
        - uri:
            prefix: "/ready"
        - uri:
            prefix: "/metrics"
      route:
        - destination:
            host: gateway.flashmart.svc.cluster.local
            port:
              number: 3000
      # Rate limiting
      rateLimit:
        dimensions:
          remoteAddress: {}
        quota:
          requestsPerUnit: 100
          unit: MINUTE
    # Catch-all route to API Gateway
    - route:
        - destination:
            host: gateway.flashmart.svc.cluster.local
            port:
              number: 3000
      # Global rate limiting
      rateLimit:
        dimensions:
          remoteAddress: {}
        quota:
          requestsPerUnit: 30
          unit: MINUTE

---
# Peer Authentication - Mutual TLS between services
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: flashmart
spec:
  mtls:
    mode: PERMISSIVE  # Allow both mTLS and plain text for development
    # mode: STRICT    # Enforce mTLS in production

---
# Authorization Policy - Service-to-service access control
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: gateway-access
  namespace: flashmart
spec:
  selector:
    matchLabels:
      app: gateway
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
    - from:
        - source:
            namespaces: ["flashmart"]  # Allow internal service communication

---
# Destination Rule - Traffic policies for services
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: flashmart-services
  namespace: flashmart
spec:
  host: "*.flashmart.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL  # Enable mTLS between services
    loadBalancer:
      simple: LEAST_CONN  # Load balancing strategy
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 10
        maxRetries: 3
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# Service Entry - External service access (if needed)
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-services
  namespace: flashmart
spec:
  hosts:
    - stripe.api.com
    - rekognition.us-east-1.amazonaws.com
  ports:
    - number: 443
      name: https
      protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
